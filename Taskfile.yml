# https://taskfile.dev

version: "3"

vars:
  CERT_FOLDER: "{{.ROOT_DIR}}/certs"

env:
  CERT_FOLDER: "{{.CERT_FOLDER}}"

dotenv: [.env, .env.default]

tasks:
  certs:
    desc: Generates certificates to identify the connector
    env:
      OUT_DIR: "{{.CERT_FOLDER}}"
    cmds:
      - mkdir -p {{.CERT_FOLDER}}
      - "{{.ROOT_DIR}}/create-certs.sh"
    status:
      - test -f {{.CERT_FOLDER}}/*.pfx

  config:
    desc: Replace the environment variables in the connector properties file template
    cmds:
      - >
        envsubst
        < {{.ROOT_DIR}}/config/connector.properties.tmpl
        > {{.ROOT_DIR}}/config/connector.properties

  connector:
    desc: Starts the connector and its dependencies
    cmds:
      - task: certs
      - task: config
      - docker compose up -d --wait

  clean:
    desc: Stops the connector and its dependencies and removes all generated files and volumes
    cmds:
      - docker compose down -v
      - cmd: rm -rf {{.CERT_FOLDER}}
        ignore_error: true
      - cmd: rm -f {{.ROOT_DIR}}/config/connector.properties
        ignore_error: true
